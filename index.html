<!DOCTYPE html>
<html>

<head>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <!-- ç¼–ç  -->
    <meta charset="utf-8">
</head>

<body>
    <h1>ColorPdfSpliter Web with Pyodide</h1>

    <p>æç¤ºï¼šWebç‰ˆå†…å­˜å ç”¨è¾ƒé«˜ï¼Œé•¿æœŸå¤§æ‰¹é‡å¤„ç†å»ºè®®ä½¿ç”¨Pythonç‰ˆæœ¬</p>

    <div class="uploads" style="display: flex; flex-direction: column;">
        <label>æ‰“å¼€PDFæ–‡ä»¶</label>
        <input type="file" id="file-input" accept=".pdf" onchange="uploadFile()" disabled="disabled">
    </div>

    <br>

    <div id="output">
        â³æ­£åœ¨å‡†å¤‡ Pyodide å’Œç›¸å…³ä¾èµ–...
    </div>

    <div id="download"></div>

    <script type="text/javascript">
        let pyodide;

        // è¾“å‡ºä¿¡æ¯
        function println(message) {
            print('<br>' + message)
        }

        function print(message){
            document.getElementById('output').innerHTML += message;
        }

        // è¾“å‡ºé”™è¯¯ï¼ŒåæœŸå¯æ”¹é€ å¤„ç†
        function printError(err_message) {
            document.getElementById('output').innerHTML += '<br>å‘ç”Ÿé”™è¯¯:<br><span style="color: grey;">' + err_message + '</span>';
        }

        async function main() {
            pyodide = await loadPyodide({
                // indexURL: "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/",
                // fullStdLib: false,
                // stdout: text => {
                //     printMessage(text);
                // },
                stderr: text => {
                    println(text);
                }
            });
            println('[1/3] æ­£åœ¨åŠ è½½micropip...')
            await pyodide.loadPackage("micropip");
            const micropip = pyodide.pyimport("micropip");
            print('âœ…')
            println('[2/3] æ­£åœ¨åŠ è½½PyMuPDF...')
            await pyodide.loadPackage('https://ghostscript.com/~julian/pyodide/PyMuPDF-1.23.5-cp311-none-emscripten_3_1_32_wasm32.whl');
            // await pyodide.loadPackage('PyMuPDF-1.23.5-cp311-none-emscripten_3_1_32_wasm32.whl');
            print('âœ…')
            pyodide.runPython(`
            import sys
            print(sys.version)
            
            import fitz
            print(fitz.version)
            `)
            println('åº“å¼•ç”¨å®Œæˆ');

            //è¯»å–å½“å‰ç›®å½•ä¸‹çš„script.pyæ–‡ä»¶
            pyodide.runPython(await (await fetch("./ColorPdfSpliterWeb.py")).text());
            println('è„šæœ¬åŠ è½½å®Œæˆ');

            // æ˜¾ç¤ºä¸Šä¼ æŒ‰é’®
            document.getElementById('file-input').disabled = false;
            println('ğŸ†—å‡†å¤‡å°±ç»ª');

            return pyodide
        }
        main();

        async function uploadFile() {
            // è·å–æ–‡ä»¶è¾“å…¥
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];

            // Referred to https://github.com/pyodide/pyodide/issues/679
            var reader = new FileReader();
            reader.readAsBinaryString(file);
            reader.onload = async function (evt) {
                println('æ­£åœ¨è¯»å–æ–‡ä»¶')
                content = evt.target.result;
                var output = pyodide.runPython('from js import content\ncontent');
                var l = output.length;
                var array = new Uint8Array(l);
                for (var i = 0; i < l; i++) {
                    array[i] = output.charCodeAt(i);
                }

                pyodide.FS.writeFile(file.name, array);
                println('æ­£åœ¨å¤„ç†æ–‡ä»¶,è¯·ç¨ç­‰...å…·ä½“è¿›åº¦å¯ä»¥æŸ¥çœ‹F12çš„æ§åˆ¶å°(console)')
                var state = undefined
                try {
                    await pyodide.runPythonAsync(`
                        splitPDF('${file.name}')
                        # showAllFiles('/')
                    `);
                } catch (e) {
                    state = e.message
                    printError(e.message)
                }

                // å¦‚æœstateä¸ä¸ºundefinedï¼Œè¯´æ˜å¤„ç†å¤±è´¥
                if (state !== undefined){
                    println('âŒæ–‡ä»¶å¤„ç†å¤±è´¥')
                    return;
                }

                println('âœ…æ–‡ä»¶å¤„ç†å®Œæˆ')

                // å»é™¤'.pdf'åç¼€
                let filenameContent = file.name.slice(0, -4)
                await generateLink(`/home/pyodide/${filenameContent}_é»‘ç™½.pdf`, `${filenameContent}_é»‘ç™½.pdf`)
                await generateLink(`/home/pyodide/${filenameContent}_å½©è‰².pdf`, `${filenameContent}_å½©è‰².pdf`)
            }
        }

        async function generateLink(link, filename) {
            // await pyodide.runPython(`print(getMD5("${link}"))`)

            // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            let fileExist = await pyodide.runPython(`os.path.exists("${link}")`)
            if (!fileExist) {
                println(`æ²¡æœ‰ ${filename}`)
                return
            }

            var array
            try{
                array = await pyodide.runPython(`
                    with open('${link}', 'rb') as fh:
                        arr = fh.read()
                    import base64
                    base64.b64encode(arr).decode('utf-8')
                `);
            }catch(e){
                printError(e.message)
                return
            }

            // Decode Base64 content to binary
            const binaryContent = atob(array);

            // Create a Uint8Array from the binary content
            const arrayBuffer = new Uint8Array(binaryContent.length);
            for (let i = 0; i < binaryContent.length; i++) {
                arrayBuffer[i] = binaryContent.charCodeAt(i);
            }

            var blob = new Blob([arrayBuffer], { type: 'application/pdf' });
            var elem = window.document.createElement('a');
            elem.target = '_blank';
            elem.href = window.URL.createObjectURL(blob);
            elem.download = filename;
            elem.innerText = filename;

            // è¾“å‡º
            document.getElementById('download').innerHTML += '<br><span>ä¸‹è½½</span>';
            document.getElementById('download').appendChild(elem);
        }
    </script>

</html>